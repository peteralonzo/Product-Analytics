WITH full_table AS
(
    SELECT rz.*,
    ap.POL_EFF_DT,
    ap.ATR_E_FLAT,
    ap.ATR_E_30,
    ap.CANCEL_E_FLAT,
    ap.CANCEL_E_30,
    ap.CANCEL_FLAG
    FROM USER_DB.AD1_PA08042.RENEWAL_ZONE_2 AS rz
    JOIN DSC_PLBI_DB.APP_AUTO_PRD.AUTO_PERSISTENCY_COMBINED AS ap
    USING (POL_ID)
    WHERE POL_EFF_DT >= '2024-10-01'
    QUALIFY MAX(POL_EFF_DT) OVER (PARTITION BY ap.POL_ID) = POL_EFF_DT
)

-- E+0 Monthly Data
SELECT CASE 
WHEN ATR_E_FLAT = 1 AND CANCEL_E_FLAT = 0 THEN 'Active'
WHEN ATR_E_FLAT = 1 AND CANCEL_E_FLAT = 1 THEN 'Cancel'
WHEN ATR_E_FLAT = 0 AND CANCEL_E_FLAT = 0 AND CANCEL_FLAG = 1 THEN 'Cancel'
ELSE 'Pending' END AS STATUS,
COUNT(DISTINCT POL_ID) AS CNT
FROM full_table
-- WHERE POL_EFF_DT BETWEEN '2024-10-01' AND '2024-10-31'
-- WHERE POL_EFF_DT BETWEEN '2024-11-01' AND '2024-11-30'
-- WHERE POL_EFF_DT BETWEEN '2024-12-01' AND '2024-12-31'
WHERE POL_EFF_DT BETWEEN '2025-01-01' AND '2025-01-31'
GROUP BY STATUS

-- E+0 2-3 Month Comparison
SELECT CASE 
WHEN ATR_E_FLAT = 1 AND CANCEL_E_FLAT = 0 THEN 'Active'
WHEN ATR_E_FLAT = 1 AND CANCEL_E_FLAT = 1 THEN 'Cancel'
WHEN ATR_E_FLAT = 0 AND CANCEL_E_FLAT = 0 AND CANCEL_FLAG = 1 THEN 'Cancel'
ELSE 'Pending' END AS STATUS,
COUNT(DISTINCT POL_ID) AS CNT
FROM full_table
-- WHERE POL_EFF_DT BETWEEN '2024-10-04' AND '2024-12-30'
-- WHERE POL_EFF_DT BETWEEN '2024-11-02' AND '2025-01-30'
-- WHERE POL_EFF_DT BETWEEN '2024-12-02' AND '2025-01-30'
WHERE POL_EFF_DT BETWEEN '2025-01-02' AND '2025-03-30'
GROUP BY STATUS

-- E+30 Monthly Data
SELECT CASE 
WHEN ATR_E_30 = 1 AND CANCEL_E_30 = 0 THEN 'Active'
WHEN ATR_E_30 = 1 AND CANCEL_E_30 = 1 THEN 'Cancel'
WHEN ATR_E_30 = 0 AND CANCEL_E_30 = 0 AND CANCEL_FLAG = 1 THEN 'Cancel'
ELSE 'Pending' END AS STATUS,
COUNT(DISTINCT POL_ID) AS CNT
FROM full_table
-- WHERE POL_EFF_DT BETWEEN '2024-10-01' AND '2024-10-31'
-- WHERE POL_EFF_DT BETWEEN '2024-11-01' AND '2024-11-30'
-- WHERE POL_EFF_DT BETWEEN '2024-12-01' AND '2024-12-31'
WHERE POL_EFF_DT BETWEEN '2025-01-01' AND '2025-01-31'
GROUP BY STATUS

-- E+30 2-3 Month Comparison
SELECT CASE 
WHEN ATR_E_30 = 1 AND CANCEL_E_30 = 0 THEN 'Active'
WHEN ATR_E_30 = 1 AND CANCEL_E_30 = 1 THEN 'Cancel'
WHEN ATR_E_30 = 0 AND CANCEL_E_30 = 0 AND CANCEL_FLAG = 1 THEN 'Cancel'
ELSE 'Pending' END AS STATUS,
COUNT(DISTINCT POL_ID) AS CNT
FROM full_table
-- WHERE POL_EFF_DT BETWEEN '2024-10-04' AND '2024-12-30'
-- WHERE POL_EFF_DT BETWEEN '2024-11-02' AND '2025-01-30'
-- WHERE POL_EFF_DT BETWEEN '2024-12-02' AND '2025-01-30'
WHERE POL_EFF_DT BETWEEN '2025-01-02' AND '2025-03-30'
GROUP BY STATUS