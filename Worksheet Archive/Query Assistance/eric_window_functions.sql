select PER.RISK_ST_ABBR, PER.POL_NEW_RENEW_CD, PER.POL_EFF_DT,
case when P.INS_SCR_GRP_CD = '1' then 1.63403964544196
     when P.INS_SCR_GRP_CD = '2' then 1.51603431551964
     when P.INS_SCR_GRP_CD = '3' then 1.47877111092332
     when P.INS_SCR_GRP_CD = '4' then 1.44070560696832
     when P.INS_SCR_GRP_CD = '5' then 1.40467065849894
     when P.INS_SCR_GRP_CD = '6' then 1.37031176929581
     when P.INS_SCR_GRP_CD = '7' then 1.33600697147204
     when P.INS_SCR_GRP_CD = '8' then 1.30286854970315
     when P.INS_SCR_GRP_CD = '9' then 1.27064711547023
     when P.INS_SCR_GRP_CD = '10' then 1.23956605953393
     when P.INS_SCR_GRP_CD = '11' then 1.20767837485041
     when P.INS_SCR_GRP_CD = '12' then 1.17764511295341
     when P.INS_SCR_GRP_CD = '13' then 1.14554609933274
     when P.INS_SCR_GRP_CD = '14' then 1.11147568192309
     when P.INS_SCR_GRP_CD = '15' then 1.07762889576258
     when P.INS_SCR_GRP_CD = '16' then 1.04574418119842
     when P.INS_SCR_GRP_CD = '17' then 1.01435093944126
     when P.INS_SCR_GRP_CD = '18' then 0.983800520510295
     when P.INS_SCR_GRP_CD = '19' then 0.954686538801872
     when P.INS_SCR_GRP_CD = '20' then 0.92606122756559
     when P.INS_SCR_GRP_CD = '21' then 0.89828683072462
     when P.INS_SCR_GRP_CD = '22' then 0.871339787283196
     when P.INS_SCR_GRP_CD = '23' then 0.84549229486839
     when P.INS_SCR_GRP_CD = '24' then 0.819934076849601
     when P.INS_SCR_GRP_CD = '25' then 0.795348376904149
     when P.INS_SCR_GRP_CD = '26' then 0.771704899934098
     when P.INS_SCR_GRP_CD = '27' then 0.747604203075694
     when P.INS_SCR_GRP_CD = '28' then 0.726326320736358
     when P.INS_SCR_GRP_CD = '29' then 0.705841471226339
     when P.INS_SCR_GRP_CD = '30' then 0.684055488904208
     when P.INS_SCR_GRP_CD = '31' then 0.663184196180992
     when P.INS_SCR_GRP_CD = '32' then 0.64343497202193
     when P.INS_SCR_GRP_CD = '33' then 0.62248120481723
     when P.INS_SCR_GRP_CD = '34' then 0.59827205190884
     when P.INS_SCR_GRP_CD = '35' then 0.57557232063432
     when P.INS_SCR_GRP_CD = '36' then 0.555434536746564
     when P.INS_SCR_GRP_CD = '37' then 0.533864969116935
     when P.INS_SCR_GRP_CD = '38' then 0.513856662679202
     when P.INS_SCR_GRP_CD = '39' then 0.494689647685563
     when P.INS_SCR_GRP_CD = '40' then 0.476349503561942
     when P.INS_SCR_GRP_CD = '41' then 0.458286447458091
     when P.INS_SCR_GRP_CD = '42' then 0.441847120708228
     when P.INS_SCR_GRP_CD = '43' then 0.424117701219652
     when P.INS_SCR_GRP_CD = '44' then 0.408314174735473
     when P.INS_SCR_GRP_CD = '45' then 0.394240456233921
     when P.INS_SCR_GRP_CD = '46' then 0.382252474714128
     when P.INS_SCR_GRP_CD = '47' then 0.364460986725251
     when P.INS_SCR_GRP_CD = '48' then 0.232924573623087
     when P.INS_SCR_GRP_CD = '49' then 0.967101027779596
     when P.INS_SCR_GRP_CD = '50' then 0.950062467711341  else 0 end as FACTOR_INS_SCR,
     
case when PCARR_CATGY_CD = 'NPI' and P.NPI_RSN_CD = 'A' then 0.840315996769772
     when PCARR_CATGY_CD = 'NPI' and P.NPI_RSN_CD = 'N' then 1.000
     when PCARR_CATGY_CD = 'NPI' and P.NPI_RSN_CD = 'U' then 0.840315996769772
     when PCARR_CATGY_CD = 'xxx' and P.NPI_RSN_CD = 'A' then 0.840315996769772
     when PCARR_CATGY_CD = 'xxx' and P.NPI_RSN_CD = 'N' then 1.000
     when PCARR_CATGY_CD = 'xxx' and P.NPI_RSN_CD is null then 1.000
     when PCARR_CATGY_CD = 'xxx' and P.NPI_RSN_CD = 'U' then 0.840315996769772 else 0 end as FACTOR_PRIOR_CARR,     
     
case when PER.PCARR_BI_LMT_CD in('10/20','15/30','20/40','CSL25','25/50','CSL25-50','30/60') then 1.000
     when PER.PCARR_BI_LMT_CD in('50/100','CSL50-100') then 1.000
     when PER.PCARR_BI_LMT_CD in('CSL100-300','100/300') then 1.000
     when PER.PCARR_BI_LMT_CD in('250/500','CSL300-500','CSL 300-500','500/500','CSL500','500/1000','CSL1000') then 1.02418614422999
     when PER.PCARR_BI_LMT_CD is null then 1.000 
     when PER.PCARR_BI_LMT_CD = 'Unknown' then 1.000  else 0   end as FACTOR_PCARR_BI_LMT_CD, 
    
     
case when PER.PPV_CNT <= 1 and PER.RATE_DRVR_CNT =  1 then 0.730774263825513
     when PER.PPV_CNT <= 1 and PER.RATE_DRVR_CNT =  2 then 0.730774263825513
     when PER.PPV_CNT <= 1 and PER.RATE_DRVR_CNT =  3 then 0.55198959959857
     when PER.PPV_CNT <= 1 and PER.RATE_DRVR_CNT =  4 then 0.55198959959857
     when PER.PPV_CNT <= 1 and PER.RATE_DRVR_CNT >= 5 then 0.55198959959857       
     when PER.PPV_CNT = 2 and PER.RATE_DRVR_CNT =  1 then 1.000
     when PER.PPV_CNT = 2 and PER.RATE_DRVR_CNT =  2 then 1.000
     when PER.PPV_CNT = 2 and PER.RATE_DRVR_CNT =  3 then 0.755348986578937
     when PER.PPV_CNT = 2 and PER.RATE_DRVR_CNT =  4 then 0.755348986578937
     when PER.PPV_CNT = 2 and PER.RATE_DRVR_CNT >= 5 then 0.755348986578937
     when PER.PPV_CNT = 3 and PER.RATE_DRVR_CNT =  1 then 1.23883850599948     
     when PER.PPV_CNT = 3 and PER.RATE_DRVR_CNT =  2 then 1.23883850599948
     when PER.PPV_CNT = 3 and PER.RATE_DRVR_CNT =  3 then 0.93575541004167
     when PER.PPV_CNT = 3 and PER.RATE_DRVR_CNT =  4 then 0.93575541004167
     when PER.PPV_CNT = 3 and PER.RATE_DRVR_CNT >= 5 then 0.93575541004167
     when PER.PPV_CNT>= 4 and PER.RATE_DRVR_CNT = 1  then 1.36031965398418
     when PER.PPV_CNT>= 4 and PER.RATE_DRVR_CNT = 2  then 1.36031965398418       
     when PER.PPV_CNT>= 4 and PER.RATE_DRVR_CNT = 3  then 1.02751607206036
     when PER.PPV_CNT>= 4 and PER.RATE_DRVR_CNT = 4  then 1.02751607206036       
     when PER.PPV_CNT>= 4 and PER.RATE_DRVR_CNT >= 5 then 1.02751607206036 else 0 end as FACTOR_HH_COMP,     
     
case when PER.POL_FORM_CD = 'H*' then 0.719838063709219
     when PER.POL_FORM_CD = '0' then 0.644420315620439
     when PER.POL_FORM_CD in ('2','HO2')then 1.000
     when PER.POL_FORM_CD in ('3','HO3') then 1.000
     when PER.POL_FORM_CD in ('4','HO4')then 0.957809203833604
     when PER.POL_FORM_CD in ('5','HO5') then 1.000
     when PER.POL_FORM_CD in ('6','HO6') then 1.000 else 0 end as FACTOR_FORM,    
     
case when PER.POL_TTL_CHRG_AFA_CNT + PER.POL_TTL_NCHRG_AFA_CNT + PER.POL_TTL_NAF_ACCID_CNT = 0 then 1.000
     when PER.POL_TTL_CHRG_AFA_CNT + PER.POL_TTL_NCHRG_AFA_CNT + PER.POL_TTL_NAF_ACCID_CNT = 1 then 0.814810211799829     
     when PER.POL_TTL_CHRG_AFA_CNT + PER.POL_TTL_NCHRG_AFA_CNT + PER.POL_TTL_NAF_ACCID_CNT = 2 then 0.663915681253282         
     when PER.POL_TTL_CHRG_AFA_CNT + PER.POL_TTL_NCHRG_AFA_CNT + PER.POL_TTL_NAF_ACCID_CNT = 3 then 0.540965276859214       
     when PER.POL_TTL_CHRG_AFA_CNT + PER.POL_TTL_NCHRG_AFA_CNT + PER.POL_TTL_NAF_ACCID_CNT = 4 then 0.440784031814009       
     when PER.POL_TTL_CHRG_AFA_CNT + PER.POL_TTL_NCHRG_AFA_CNT + PER.POL_TTL_NAF_ACCID_CNT = 5 then 0.359155330320355 
     when PER.POL_TTL_CHRG_AFA_CNT + PER.POL_TTL_NCHRG_AFA_CNT + PER.POL_TTL_NAF_ACCID_CNT = 6 then 0.292643430767366         
     when PER.POL_TTL_CHRG_AFA_CNT + PER.POL_TTL_NCHRG_AFA_CNT + PER.POL_TTL_NAF_ACCID_CNT = 7 then 0.238448855805386         
     when PER.POL_TTL_CHRG_AFA_CNT + PER.POL_TTL_NCHRG_AFA_CNT + PER.POL_TTL_NAF_ACCID_CNT = 8 then 0.194290562702213         
     when PER.POL_TTL_CHRG_AFA_CNT + PER.POL_TTL_NCHRG_AFA_CNT + PER.POL_TTL_NAF_ACCID_CNT >=9 then 0.158309934546098 else 0 end as FACTOR_ACCID,     
     
case when P.PCARR_CALC_YR_CNT is null then 0.845420652174304
     when least(round(P.PCARR_CALC_YR_CNT,0),10) = 0 then 0.845420652174304
     when least(round(P.PCARR_CALC_YR_CNT,0),10) = 0.5 then 0.845420652174304    
     when least(round(P.PCARR_CALC_YR_CNT,0),10) = 1 then 0.845420652174304   
     when least(round(P.PCARR_CALC_YR_CNT,0),10) = 2 then 0.882  
     when least(round(P.PCARR_CALC_YR_CNT,0),10) = 3 then 0.919
     when least(round(P.PCARR_CALC_YR_CNT,0),10) = 4 then 0.959 
     when least(round(P.PCARR_CALC_YR_CNT,0),10) = 5 then 1.000
     when least(round(P.PCARR_CALC_YR_CNT,0),10) = 6 then 1.043
     when least(round(P.PCARR_CALC_YR_CNT,0),10) = 7 then 1.088 
     when least(round(P.PCARR_CALC_YR_CNT,0),10) = 8 then 1.134     
     when least(round(P.PCARR_CALC_YR_CNT,0),10) = 9 then 1.183 
     when least(round(P.PCARR_CALC_YR_CNT,0),10)>= 10 then 1.234 else 0 end as FACTOR_YPC,           
     
case when PER.ADV_QTE_DAY_CNT <=0 then 0.879
     when PER.ADV_QTE_DAY_CNT is null then 0.879
     when PER.ADV_QTE_DAY_CNT between 1  and 60 then 1.06160269159112
     when PER.ADV_QTE_DAY_CNT between 61 and 75 then 1.039     
     when PER.ADV_QTE_DAY_CNT >= 76 then 1.000 else 0 end as FACTOR_AQD, 
          
case when PER.POL_RATE_DRVR_MAX_AGE <=70 then 1.000
     when PER.POL_RATE_DRVR_MAX_AGE = '71' then 0.992371585384484
     when PER.POL_RATE_DRVR_MAX_AGE = '72' then 0.986661093700862
     when PER.POL_RATE_DRVR_MAX_AGE = '73' then 0.98199365031042
     when PER.POL_RATE_DRVR_MAX_AGE = '74' then 0.977516239125978
     when PER.POL_RATE_DRVR_MAX_AGE = '75' then 0.972392361660181
     when PER.POL_RATE_DRVR_MAX_AGE = '76' then 0.965803966036549
     when PER.POL_RATE_DRVR_MAX_AGE = '77' then 0.956960362708807
     when PER.POL_RATE_DRVR_MAX_AGE = '78' then 0.945113715632746
     when PER.POL_RATE_DRVR_MAX_AGE = '79' then 0.929580412966622
     when PER.POL_RATE_DRVR_MAX_AGE = '80' then 0.909767202876551
     when PER.POL_RATE_DRVR_MAX_AGE = '81' then 0.885200466221903
     when PER.POL_RATE_DRVR_MAX_AGE = '82' then 0.855556447065057
     when PER.POL_RATE_DRVR_MAX_AGE = '83' then 0.820689752717067
     when PER.POL_RATE_DRVR_MAX_AGE = '84' then 0.780657062289996
     when PER.POL_RATE_DRVR_MAX_AGE = '85' then 0.735732848000991
     when PER.POL_RATE_DRVR_MAX_AGE = '86' then 0.686414109763162
     when PER.POL_RATE_DRVR_MAX_AGE = '87' then 0.633411716098158
     when PER.POL_RATE_DRVR_MAX_AGE = '88' then 0.577626950054141
     when PER.POL_RATE_DRVR_MAX_AGE = '89' then 0.520113229105798
     when PER.POL_RATE_DRVR_MAX_AGE >='90' then 0.462024580306269
else 0 end as FACTOR_MAX_AGE,                   
     
case when PER.POL_TTL_DWI_MAJ_VIO_CNT + PER.POL_TTL_NON_DWI_MAJ_CNT + PER.POL_TTL_SPEED_MNR_VIO_CNT + PER.POL_TTL_NSPD_MNR_VIO_CNT = 0 then 1.000
     when PER.POL_TTL_DWI_MAJ_VIO_CNT + PER.POL_TTL_NON_DWI_MAJ_CNT + PER.POL_TTL_SPEED_MNR_VIO_CNT + PER.POL_TTL_NSPD_MNR_VIO_CNT = 1 then 0.787     
     when PER.POL_TTL_DWI_MAJ_VIO_CNT + PER.POL_TTL_NON_DWI_MAJ_CNT + PER.POL_TTL_SPEED_MNR_VIO_CNT + PER.POL_TTL_NSPD_MNR_VIO_CNT = 2 then 0.620         
     when PER.POL_TTL_DWI_MAJ_VIO_CNT + PER.POL_TTL_NON_DWI_MAJ_CNT + PER.POL_TTL_SPEED_MNR_VIO_CNT + PER.POL_TTL_NSPD_MNR_VIO_CNT = 3 then 0.488        
     when PER.POL_TTL_DWI_MAJ_VIO_CNT + PER.POL_TTL_NON_DWI_MAJ_CNT + PER.POL_TTL_SPEED_MNR_VIO_CNT + PER.POL_TTL_NSPD_MNR_VIO_CNT = 4 then 0.384         
     when PER.POL_TTL_DWI_MAJ_VIO_CNT + PER.POL_TTL_NON_DWI_MAJ_CNT + PER.POL_TTL_SPEED_MNR_VIO_CNT + PER.POL_TTL_NSPD_MNR_VIO_CNT = 5 then 0.302  
     when PER.POL_TTL_DWI_MAJ_VIO_CNT + PER.POL_TTL_NON_DWI_MAJ_CNT + PER.POL_TTL_SPEED_MNR_VIO_CNT + PER.POL_TTL_NSPD_MNR_VIO_CNT = 6 then 0.238         
     when PER.POL_TTL_DWI_MAJ_VIO_CNT + PER.POL_TTL_NON_DWI_MAJ_CNT + PER.POL_TTL_SPEED_MNR_VIO_CNT + PER.POL_TTL_NSPD_MNR_VIO_CNT = 7 then 0.187         
     when PER.POL_TTL_DWI_MAJ_VIO_CNT + PER.POL_TTL_NON_DWI_MAJ_CNT + PER.POL_TTL_SPEED_MNR_VIO_CNT + PER.POL_TTL_NSPD_MNR_VIO_CNT = 8 then 0.148         
     when PER.POL_TTL_DWI_MAJ_VIO_CNT + PER.POL_TTL_NON_DWI_MAJ_CNT + PER.POL_TTL_SPEED_MNR_VIO_CNT + PER.POL_TTL_NSPD_MNR_VIO_CNT >=9 then 0.116 else 0 end as FACTOR_VIO,
     
sum(PER.ATR_E_FLAT) OVER (PARTITION BY PER.RISK_ST_ABBR, PER.POL_NEW_RENEW_CD, PER.POL_EFF_DT) as ATR_FLAT,
sum(PER.ATR_E_30) OVER (PARTITION BY PER.RISK_ST_ABBR, PER.POL_NEW_RENEW_CD, PER.POL_EFF_DT) as ATR_30,
sum(PER.ATR_E_60) OVER (PARTITION BY PER.RISK_ST_ABBR, PER.POL_NEW_RENEW_CD, PER.POL_EFF_DT) as ATR_60,
sum(PER.ATR_E_90) OVER (PARTITION BY PER.RISK_ST_ABBR, PER.POL_NEW_RENEW_CD, PER.POL_EFF_DT) as ATR_90,
sum(PER.ATR_E_185) OVER (PARTITION BY PER.RISK_ST_ABBR, PER.POL_NEW_RENEW_CD, PER.POL_EFF_DT) as ATR_185,
sum(PER.ULT_ATR_CNT) OVER (PARTITION BY PER.RISK_ST_ABBR, PER.POL_NEW_RENEW_CD, PER.POL_EFF_DT) as ATR_ULT,
  
 sum(PER.CANCEL_E_FLAT) OVER (PARTITION BY PER.RISK_ST_ABBR, PER.POL_NEW_RENEW_CD, PER.POL_EFF_DT) as CAN_FLAT,
sum(PER.CANCEL_E_30) OVER (PARTITION BY PER.RISK_ST_ABBR, PER.POL_NEW_RENEW_CD, PER.POL_EFF_DT) as CAN_30,
sum(PER.CANCEL_E_60) OVER (PARTITION BY PER.RISK_ST_ABBR, PER.POL_NEW_RENEW_CD, PER.POL_EFF_DT) as CAN_60,
sum(PER.CANCEL_E_90) OVER (PARTITION BY PER.RISK_ST_ABBR, PER.POL_NEW_RENEW_CD, PER.POL_EFF_DT) as CAN_90,
sum(PER.CANCEL_E_185) OVER (PARTITION BY PER.RISK_ST_ABBR, PER.POL_NEW_RENEW_CD, PER.POL_EFF_DT) as CAN_185,
sum(PER.ULT_CANC_CNT) OVER (PARTITION BY PER.RISK_ST_ABBR, PER.POL_NEW_RENEW_CD, PER.POL_EFF_DT) as CAN_ULT,
FACTOR_INS_SCR * FACTOR_PRIOR_CARR *  FACTOR_PCARR_BI_LMT_CD *   FACTOR_HH_COMP  *      FACTOR_FORM  *   FACTOR_ACCID  *     FACTOR_YPC  *     FACTOR_AQD  *      FACTOR_MAX_AGE   * FACTOR_VIO *      EXP(1.91)           as Factor,
round(Factor/(1+Factor),3) as Pred_Ret,

from "DSC_PLBI_DB"."APP_AUTO_PRD"."AUTO_PERSISTENCY_NEWCO" PER 
left join PRD_PL_DB.APP_DCPA_AUTO_CURATE.AUTO_POLICY p
    on PER.AUTO_POL_TRANS_ID = P.AUTO_POL_TRANS_ID


where 
PER.POL_EFF_DT >= '2023-10-01'
and PER.POL_NEW_RENEW_CD = 'N'
